name: Deploy Backend to Railway

on:
  push:
    branches: [ main ]
    paths: 
      - 'backend/**'
      - '.github/workflows/deploy-railway.yml'
  workflow_dispatch:

jobs:
  deploy-backend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Notify Deployment Start
        run: |
          echo "ğŸš€ Starting backend deployment to Railway..."
          echo "Timestamp: $(date)"
      
      - name: Wait for Railway Auto-Deploy
        run: |
          echo "Railway auto-deploys from GitHub push"
          echo "Waiting 90 seconds for Railway build and deployment..."
          sleep 90

      - name: Health Check Backend
        run: |
          echo "ğŸ¥ Checking backend health..."
          max_attempts=15
          attempt=0
          
          while [ $attempt -lt $max_attempts ]; do
            echo "Attempt $((attempt+1))/$max_attempts..."
            
            # Check if health endpoint responds
            if curl -sf --max-time 10 https://naija-conflict-tracker-production.up.railway.app/health > /dev/null 2>&1; then
              echo "âœ… Backend is healthy and responding!"
              exit 0
            fi
            
            echo "â³ Backend not ready yet, waiting 10 seconds..."
            sleep 10
            attempt=$((attempt+1))
          done
          
          echo "âŒ Backend health check failed after $max_attempts attempts"
          echo "Manual intervention required"
          exit 1

      - name: Deployment Success
        run: |
          echo "================================"
          echo "âœ… Backend deployment complete!"
          echo "ğŸ”— API URL: https://naija-conflict-tracker-production.up.railway.app"
          echo "ğŸ“Š Health: https://naija-conflict-tracker-production.up.railway.app/health"
          echo "================================"
